const { test, expect, devices } = require('@playwright/test');\nconst path = require('path');\n\n// Test configuration\nconst TEST_URL = process.env.TEST_URL || 'http://localhost:3000';\nconst API_URL = process.env.API_URL || 'http://localhost:3001';\n\n// Helper function to wait for app to be ready\nconst waitForAppReady = async (page) => {\n  // Wait for React app to load\n  await page.waitForSelector('[data-testid=\"app-loaded\"]', { \n    timeout: 10000,\n    state: 'visible' \n  });\n  \n  // Wait for any loading indicators to disappear\n  await page.waitForSelector('[role=\"progressbar\"]', { \n    state: 'hidden',\n    timeout: 5000 \n  }).catch(() => {}); // Ignore if no loading indicator\n};\n\n// Helper to create test tasks via API\nconst createTestTask = async (request, taskData = {}) => {\n  const defaultTask = {\n    title: 'Test Task',\n    description: 'A test task description',\n    completed: false,\n    priority: 2,\n    dueDate: null\n  };\n  \n  const response = await request.post(`${API_URL}/api/tasks`, {\n    data: { ...defaultTask, ...taskData }\n  });\n  \n  return response.json();\n};\n\n// Helper to clean up test data\nconst cleanupTestData = async (request) => {\n  // Delete all tasks with \"Test\" in the title\n  const response = await request.get(`${API_URL}/api/tasks?search=Test`);\n  const tasks = await response.json();\n  \n  if (tasks.tasks && tasks.tasks.length > 0) {\n    const taskIds = tasks.tasks.map(task => task.id);\n    await request.delete(`${API_URL}/api/tasks/bulk`, {\n      data: { taskIds }\n    });\n  }\n};\n\ntest.describe('End-to-End Task Management Tests', () => {\n  test.beforeEach(async ({ page, request }) => {\n    // Clean up any existing test data\n    await cleanupTestData(request);\n    \n    // Navigate to the app\n    await page.goto(TEST_URL);\n    await waitForAppReady(page);\n  });\n\n  test.afterEach(async ({ request }) => {\n    // Clean up after each test\n    await cleanupTestData(request);\n  });\n\n  test.describe('Core Task Operations', () => {\n    test('should create, edit, and delete a task', async ({ page }) => {\n      // Create task\n      await page.click('[data-testid=\"add-task-button\"]');\n      await page.waitForSelector('[role=\"dialog\"]');\n      \n      await page.fill('[data-testid=\"task-title-input\"]', 'E2E Test Task');\n      await page.fill('[data-testid=\"task-description-input\"]', 'This is an E2E test task');\n      await page.selectOption('[data-testid=\"task-priority-select\"]', '3');\n      \n      await page.click('[data-testid=\"create-task-button\"]');\n      \n      // Verify task appears in list\n      await expect(page.locator('[data-testid=\"task-card\"]')).toContainText('E2E Test Task');\n      \n      // Edit task\n      await page.click('[data-testid=\"task-card\"]:has-text(\"E2E Test Task\") [data-testid=\"edit-task-button\"]');\n      await page.waitForSelector('[role=\"dialog\"]');\n      \n      await page.fill('[data-testid=\"task-title-input\"]', 'Updated E2E Task');\n      await page.click('[data-testid=\"update-task-button\"]');\n      \n      // Verify task was updated\n      await expect(page.locator('[data-testid=\"task-card\"]')).toContainText('Updated E2E Task');\n      \n      // Complete task\n      await page.click('[data-testid=\"task-card\"]:has-text(\"Updated E2E Task\") [data-testid=\"complete-task-checkbox\"]');\n      \n      // Verify task is marked as completed\n      await expect(\n        page.locator('[data-testid=\"task-card\"]:has-text(\"Updated E2E Task\") [data-testid=\"complete-task-checkbox\"]')\n      ).toBeChecked();\n      \n      // Delete task\n      await page.click('[data-testid=\"task-card\"]:has-text(\"Updated E2E Task\") [data-testid=\"delete-task-button\"]');\n      await page.click('[data-testid=\"confirm-delete-button\"]');\n      \n      // Verify task is removed\n      await expect(page.locator('[data-testid=\"task-card\"]:has-text(\"Updated E2E Task\")')).toHaveCount(0);\n    });\n\n    test('should handle task due dates', async ({ page }) => {\n      await page.click('[data-testid=\"add-task-button\"]');\n      await page.fill('[data-testid=\"task-title-input\"]', 'Task with Due Date');\n      \n      // Set due date to tomorrow\n      const tomorrow = new Date();\n      tomorrow.setDate(tomorrow.getDate() + 1);\n      const tomorrowString = tomorrow.toISOString().split('T')[0];\n      \n      await page.fill('[data-testid=\"task-due-date-input\"]', tomorrowString);\n      await page.click('[data-testid=\"create-task-button\"]');\n      \n      // Verify due date is displayed\n      const taskCard = page.locator('[data-testid=\"task-card\"]:has-text(\"Task with Due Date\")');\n      await expect(taskCard).toContainText('Due:');\n      \n      // Check that overdue tasks are highlighted\n      await page.click('[data-testid=\"task-card\"]:has-text(\"Task with Due Date\") [data-testid=\"edit-task-button\"]');\n      \n      // Set due date to yesterday\n      const yesterday = new Date();\n      yesterday.setDate(yesterday.getDate() - 1);\n      const yesterdayString = yesterday.toISOString().split('T')[0];\n      \n      await page.fill('[data-testid=\"task-due-date-input\"]', yesterdayString);\n      await page.click('[data-testid=\"update-task-button\"]');\n      \n      // Verify overdue styling\n      await expect(taskCard).toHaveClass(/overdue/);\n    });\n    \n    test('should handle drag and drop reordering', async ({ page }) => {\n      // Create multiple tasks\n      const tasks = ['First Task', 'Second Task', 'Third Task'];\n      \n      for (const taskTitle of tasks) {\n        await page.click('[data-testid=\"add-task-button\"]');\n        await page.fill('[data-testid=\"task-title-input\"]', taskTitle);\n        await page.click('[data-testid=\"create-task-button\"]');\n        await page.waitForTimeout(100); // Small delay between tasks\n      }\n      \n      // Get initial order\n      const initialOrder = await page.locator('[data-testid=\"task-card\"] [data-testid=\"task-title\"]').allTextContents();\n      expect(initialOrder).toEqual(tasks);\n      \n      // Drag first task to third position\n      const firstTask = page.locator('[data-testid=\"task-card\"]').first();\n      const thirdTask = page.locator('[data-testid=\"task-card\"]').nth(2);\n      \n      await firstTask.dragTo(thirdTask);\n      \n      // Verify new order\n      await page.waitForTimeout(500); // Wait for reorder animation\n      const newOrder = await page.locator('[data-testid=\"task-card\"] [data-testid=\"task-title\"]').allTextContents();\n      expect(newOrder).toEqual(['Second Task', 'Third Task', 'First Task']);\n    });\n  });\n\n  test.describe('Filtering and Search', () => {\n    test.beforeEach(async ({ request }) => {\n      // Create test tasks with different properties\n      const testTasks = [\n        { title: 'Urgent Work Task', description: 'Important work', priority: 3, completed: false, tags: ['work', 'urgent'] },\n        { title: 'Personal Shopping', description: 'Buy groceries', priority: 1, completed: false, tags: ['personal'] },\n        { title: 'Completed Project', description: 'Finished project', priority: 2, completed: true, tags: ['work', 'project'] },\n        { title: 'Meeting Preparation', description: 'Prepare slides', priority: 2, completed: false, tags: ['work', 'meeting'] }\n      ];\n      \n      for (const task of testTasks) {\n        await createTestTask(request, task);\n      }\n    });\n\n    test('should filter tasks by completion status', async ({ page }) => {\n      await page.goto(TEST_URL);\n      await waitForAppReady(page);\n      \n      // Filter for incomplete tasks only\n      await page.click('[data-testid=\"filter-incomplete-button\"]');\n      \n      const visibleTasks = page.locator('[data-testid=\"task-card\"]');\n      await expect(visibleTasks).toHaveCount(3); // Should show 3 incomplete tasks\n      \n      // Verify no completed tasks are shown\n      await expect(page.locator('[data-testid=\"task-card\"]:has-text(\"Completed Project\")')).toHaveCount(0);\n      \n      // Filter for completed tasks only\n      await page.click('[data-testid=\"filter-completed-button\"]');\n      await expect(visibleTasks).toHaveCount(1); // Should show 1 completed task\n      await expect(page.locator('[data-testid=\"task-card\"]:has-text(\"Completed Project\")')).toHaveCount(1);\n    });\n\n    test('should filter tasks by priority', async ({ page }) => {\n      await page.goto(TEST_URL);\n      await waitForAppReady(page);\n      \n      // Filter for high priority tasks\n      await page.selectOption('[data-testid=\"priority-filter-select\"]', '3');\n      \n      const visibleTasks = page.locator('[data-testid=\"task-card\"]');\n      await expect(visibleTasks).toHaveCount(1); // Should show 1 high priority task\n      await expect(page.locator('[data-testid=\"task-card\"]:has-text(\"Urgent Work Task\")')).toHaveCount(1);\n    });\n\n    test('should search tasks by text', async ({ page }) => {\n      await page.goto(TEST_URL);\n      await waitForAppReady(page);\n      \n      // Search for \"work\" - should match title and description\n      await page.fill('[data-testid=\"search-input\"]', 'work');\n      \n      // Wait for search results\n      await page.waitForTimeout(500); // Debounce delay\n      \n      const visibleTasks = page.locator('[data-testid=\"task-card\"]');\n      await expect(visibleTasks).toHaveCount(3); // Should show 3 work-related tasks\n      \n      // Clear search\n      await page.fill('[data-testid=\"search-input\"]', '');\n      await expect(visibleTasks).toHaveCount(4); // Should show all tasks\n    });\n\n    test('should combine multiple filters', async ({ page }) => {\n      await page.goto(TEST_URL);\n      await waitForAppReady(page);\n      \n      // Filter for incomplete work tasks with medium+ priority\n      await page.click('[data-testid=\"filter-incomplete-button\"]');\n      await page.fill('[data-testid=\"search-input\"]', 'work');\n      await page.selectOption('[data-testid=\"priority-filter-select\"]', '2'); // Medium priority and above\n      \n      await page.waitForTimeout(500);\n      \n      const visibleTasks = page.locator('[data-testid=\"task-card\"]');\n      await expect(visibleTasks).toHaveCount(2); // Should show 2 tasks matching all criteria\n    });\n  });\n\n  test.describe('Accessibility Features', () => {\n    test('should be navigable with keyboard only', async ({ page }) => {\n      await page.goto(TEST_URL);\n      await waitForAppReady(page);\n      \n      // Tab through the interface\n      await page.keyboard.press('Tab');\n      await expect(page.locator(':focus')).toBeVisible();\n      \n      // Navigate to add task button and activate with keyboard\n      while (!(await page.locator('[data-testid=\"add-task-button\"]:focus').count())) {\n        await page.keyboard.press('Tab');\n      }\n      \n      await page.keyboard.press('Enter');\n      await expect(page.locator('[role=\"dialog\"]')).toBeVisible();\n      \n      // Fill form with keyboard\n      await page.keyboard.type('Keyboard Navigation Task');\n      await page.keyboard.press('Tab');\n      await page.keyboard.type('Created using only keyboard');\n      \n      // Submit with keyboard\n      await page.keyboard.press('Tab');\n      await page.keyboard.press('Tab');\n      await page.keyboard.press('Enter');\n      \n      // Verify task was created\n      await expect(page.locator('[data-testid=\"task-card\"]:has-text(\"Keyboard Navigation Task\")')).toBeVisible();\n    });\n\n    test('should provide screen reader announcements', async ({ page }) => {\n      await page.goto(TEST_URL);\n      await waitForAppReady(page);\n      \n      // Check for ARIA live regions\n      await expect(page.locator('[aria-live=\"polite\"]')).toBeVisible();\n      \n      // Create a task and verify announcement\n      await page.click('[data-testid=\"add-task-button\"]');\n      await page.fill('[data-testid=\"task-title-input\"]', 'Screen Reader Test');\n      await page.click('[data-testid=\"create-task-button\"]');\n      \n      // Check that success message appears in live region\n      const liveRegion = page.locator('[aria-live=\"polite\"]');\n      await expect(liveRegion).toContainText(/created successfully/i);\n    });\n\n    test('should support high contrast mode', async ({ page }) => {\n      await page.goto(TEST_URL);\n      await waitForAppReady(page);\n      \n      // Toggle to high contrast theme\n      await page.click('[data-testid=\"theme-toggle-button\"]');\n      await page.click('[data-testid=\"high-contrast-option\"]');\n      \n      // Verify high contrast styles are applied\n      const body = page.locator('body');\n      await expect(body).toHaveAttribute('data-theme', 'high-contrast');\n      \n      // Check that text has sufficient contrast\n      const taskCards = page.locator('[data-testid=\"task-card\"]');\n      if (await taskCards.count() === 0) {\n        // Create a task first\n        await page.click('[data-testid=\"add-task-button\"]');\n        await page.fill('[data-testid=\"task-title-input\"]', 'Contrast Test Task');\n        await page.click('[data-testid=\"create-task-button\"]');\n      }\n      \n      const firstCard = taskCards.first();\n      const styles = await firstCard.evaluate(el => {\n        const computed = window.getComputedStyle(el);\n        return {\n          color: computed.color,\n          backgroundColor: computed.backgroundColor,\n          borderColor: computed.borderColor\n        };\n      });\n      \n      // High contrast should use contrasting colors\n      expect(styles.color).toBeTruthy();\n      expect(styles.backgroundColor).toBeTruthy();\n    });\n\n    test('should handle reduced motion preferences', async ({ page }) => {\n      // Set reduced motion preference\n      await page.emulateMedia({ reducedMotion: 'reduce' });\n      \n      await page.goto(TEST_URL);\n      await waitForAppReady(page);\n      \n      // Create a task to trigger animations\n      await page.click('[data-testid=\"add-task-button\"]');\n      await page.fill('[data-testid=\"task-title-input\"]', 'Reduced Motion Task');\n      await page.click('[data-testid=\"create-task-button\"]');\n      \n      // Verify that animations are disabled or reduced\n      const taskCard = page.locator('[data-testid=\"task-card\"]:has-text(\"Reduced Motion Task\")');\n      const animationDuration = await taskCard.evaluate(el => {\n        const computed = window.getComputedStyle(el);\n        return computed.animationDuration;\n      });\n      \n      // Should have no animation or very short duration\n      expect(animationDuration === '0s' || animationDuration === '0.01s').toBeTruthy();\n    });\n  });\n\n  test.describe('Performance Tests', () => {\n    test('should load quickly with many tasks', async ({ page, request }) => {\n      // Create many test tasks\n      const taskPromises = [];\n      for (let i = 1; i <= 100; i++) {\n        taskPromises.push(\n          createTestTask(request, {\n            title: `Performance Test Task ${i}`,\n            description: `Task ${i} for performance testing`,\n            priority: (i % 3) + 1,\n            completed: i % 4 === 0\n          })\n        );\n      }\n      await Promise.all(taskPromises);\n      \n      // Measure page load time\n      const startTime = Date.now();\n      await page.goto(TEST_URL);\n      await waitForAppReady(page);\n      const loadTime = Date.now() - startTime;\n      \n      // Should load within reasonable time\n      expect(loadTime).toBeLessThan(5000); // 5 seconds\n      \n      // Verify pagination is working\n      const visibleTasks = page.locator('[data-testid=\"task-card\"]');\n      const taskCount = await visibleTasks.count();\n      expect(taskCount).toBeLessThanOrEqual(20); // Should paginate\n      \n      // Test scrolling performance\n      await page.evaluate(() => {\n        const taskList = document.querySelector('[data-testid=\"task-list\"]');\n        if (taskList) {\n          taskList.scrollTop = taskList.scrollHeight;\n        }\n      });\n      \n      // Should load more tasks or show pagination\n      await page.waitForTimeout(1000); // Wait for any lazy loading\n    });\n\n    test('should handle rapid user interactions', async ({ page }) => {\n      await page.goto(TEST_URL);\n      await waitForAppReady(page);\n      \n      const startTime = Date.now();\n      \n      // Perform rapid interactions\n      for (let i = 0; i < 10; i++) {\n        await page.click('[data-testid=\"theme-toggle-button\"]');\n        await page.waitForTimeout(10);\n      }\n      \n      const interactionTime = Date.now() - startTime;\n      \n      // Should handle rapid interactions without significant delay\n      expect(interactionTime).toBeLessThan(2000);\n      \n      // UI should still be responsive\n      await expect(page.locator('[data-testid=\"add-task-button\"]')).toBeEnabled();\n    });\n  });\n\n  test.describe('Cross-Browser Compatibility', () => {\n    ['chromium', 'firefox', 'webkit'].forEach(browserName => {\n      test(`should work correctly in ${browserName}`, async ({ page }) => {\n        await page.goto(TEST_URL);\n        await waitForAppReady(page);\n        \n        // Basic functionality test\n        await page.click('[data-testid=\"add-task-button\"]');\n        await page.fill('[data-testid=\"task-title-input\"]', `${browserName} Test Task`);\n        await page.click('[data-testid=\"create-task-button\"]');\n        \n        await expect(page.locator(`[data-testid=\"task-card\"]:has-text(\"${browserName} Test Task\")`)).toBeVisible();\n        \n        // Theme switching\n        await page.click('[data-testid=\"theme-toggle-button\"]');\n        await expect(page.locator('body')).toHaveAttribute('data-theme', expect.stringMatching(/(dark|light)/));\n      });\n    });\n  });\n\n  test.describe('Mobile Responsiveness', () => {\n    test('should work on mobile devices', async ({ page }) => {\n      // Set mobile viewport\n      await page.setViewportSize({ width: 375, height: 667 });\n      \n      await page.goto(TEST_URL);\n      await waitForAppReady(page);\n      \n      // Mobile navigation should be visible\n      await expect(page.locator('[data-testid=\"mobile-menu-button\"]')).toBeVisible();\n      \n      // Add task on mobile\n      await page.click('[data-testid=\"mobile-add-button\"]');\n      await page.fill('[data-testid=\"task-title-input\"]', 'Mobile Test Task');\n      await page.click('[data-testid=\"create-task-button\"]');\n      \n      // Task should be visible\n      await expect(page.locator('[data-testid=\"task-card\"]:has-text(\"Mobile Test Task\")')).toBeVisible();\n      \n      // Touch interactions\n      const taskCard = page.locator('[data-testid=\"task-card\"]:has-text(\"Mobile Test Task\")');\n      await taskCard.tap();\n      \n      // Should expand or show actions\n      await expect(page.locator('[data-testid=\"task-actions\"]')).toBeVisible();\n    });\n\n    test('should handle orientation changes', async ({ page }) => {\n      // Start in portrait\n      await page.setViewportSize({ width: 375, height: 667 });\n      await page.goto(TEST_URL);\n      await waitForAppReady(page);\n      \n      // Switch to landscape\n      await page.setViewportSize({ width: 667, height: 375 });\n      \n      // UI should adapt to landscape\n      await expect(page.locator('[data-testid=\"landscape-layout\"]')).toBeVisible();\n      \n      // Functionality should still work\n      await page.click('[data-testid=\"add-task-button\"]');\n      await expect(page.locator('[role=\"dialog\"]')).toBeVisible();\n    });\n  });\n\n  test.describe('Error Handling', () => {\n    test('should handle network errors gracefully', async ({ page }) => {\n      await page.goto(TEST_URL);\n      await waitForAppReady(page);\n      \n      // Simulate network failure\n      await page.route('**/api/tasks', route => {\n        route.abort('failed');\n      });\n      \n      // Try to create a task\n      await page.click('[data-testid=\"add-task-button\"]');\n      await page.fill('[data-testid=\"task-title-input\"]', 'Network Error Test');\n      await page.click('[data-testid=\"create-task-button\"]');\n      \n      // Should show error message\n      await expect(page.locator('[data-testid=\"error-message\"]')).toContainText(/network error|failed to save/i);\n      \n      // Should allow retry\n      await expect(page.locator('[data-testid=\"retry-button\"]')).toBeVisible();\n    });\n\n    test('should recover from server errors', async ({ page }) => {\n      await page.goto(TEST_URL);\n      await waitForAppReady(page);\n      \n      // Simulate server error\n      await page.route('**/api/tasks', route => {\n        route.fulfill({ status: 500, body: 'Internal Server Error' });\n      });\n      \n      // Try to load tasks\n      await page.reload();\n      \n      // Should show error state\n      await expect(page.locator('[data-testid=\"error-state\"]')).toBeVisible();\n      \n      // Remove route to simulate server recovery\n      await page.unroute('**/api/tasks');\n      \n      // Retry should work\n      await page.click('[data-testid=\"retry-button\"]');\n      await waitForAppReady(page);\n    });\n\n    test('should handle malformed data gracefully', async ({ page, request }) => {\n      // Create task with malformed data via API\n      await request.post(`${API_URL}/api/tasks`, {\n        data: {\n          title: null, // Invalid data\n          description: undefined,\n          priority: 'invalid'\n        }\n      }).catch(() => {}); // Expect this to fail\n      \n      await page.goto(TEST_URL);\n      await waitForAppReady(page);\n      \n      // App should still load normally\n      await expect(page.locator('[data-testid=\"add-task-button\"]')).toBeVisible();\n    });\n  });\n\n  test.describe('Data Persistence', () => {\n    test('should persist tasks across browser refreshes', async ({ page }) => {\n      await page.goto(TEST_URL);\n      await waitForAppReady(page);\n      \n      // Create a task\n      await page.click('[data-testid=\"add-task-button\"]');\n      await page.fill('[data-testid=\"task-title-input\"]', 'Persistent Task');\n      await page.click('[data-testid=\"create-task-button\"]');\n      \n      // Refresh the page\n      await page.reload();\n      await waitForAppReady(page);\n      \n      // Task should still be there\n      await expect(page.locator('[data-testid=\"task-card\"]:has-text(\"Persistent Task\")')).toBeVisible();\n    });\n\n    test('should persist user preferences', async ({ page }) => {\n      await page.goto(TEST_URL);\n      await waitForAppReady(page);\n      \n      // Change theme\n      await page.click('[data-testid=\"theme-toggle-button\"]');\n      \n      // Set filters\n      await page.click('[data-testid=\"filter-incomplete-button\"]');\n      await page.selectOption('[data-testid=\"priority-filter-select\"]', '3');\n      \n      // Refresh page\n      await page.reload();\n      await waitForAppReady(page);\n      \n      // Preferences should be restored\n      await expect(page.locator('body')).toHaveAttribute('data-theme', expect.stringMatching(/(dark|light)/));\n      await expect(page.locator('[data-testid=\"filter-incomplete-button\"]')).toHaveClass(/active/);\n      await expect(page.locator('[data-testid=\"priority-filter-select\"]')).toHaveValue('3');\n    });\n  });\n});